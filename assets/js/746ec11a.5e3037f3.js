"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[2723],{15680:(e,n,t)=>{t.r(n),t.d(n,{MDXContext:()=>c,MDXProvider:()=>u,mdx:()=>x,useMDXComponents:()=>m,withMDXComponents:()=>d});var r=t(96540);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(){return i=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e},i.apply(this,arguments)}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var c=r.createContext({}),d=function(e){return function(n){var t=m(n.components);return r.createElement(e,i({},n,{components:t}))}},m=function(e){var n=r.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},u=function(e){var n=m(e.components);return r.createElement(c.Provider,{value:n},e.children)},p={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},h=r.forwardRef((function(e,n){var t=e.components,a=e.mdxType,i=e.originalType,o=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),d=m(t),u=a,h=d["".concat(o,".").concat(u)]||d[u]||p[u]||i;return t?r.createElement(h,l(l({ref:n},c),{},{components:t})):r.createElement(h,l({ref:n},c))}));function x(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var i=t.length,o=new Array(i);o[0]=h;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var c=2;c<i;c++)o[c]=t[c];return r.createElement.apply(null,o)}return r.createElement.apply(null,t)}h.displayName="MDXCreateElement"},58313:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>u,contentTitle:()=>d,default:()=>b,frontMatter:()=>c,metadata:()=>m,toc:()=>p});var r,a=t(9668),i=t(21367),o=(t(96540),t(15680)),l=t(52112),s=["components"],c={id:"code-6065-public",title:"6065 - Commandline arguments injection",sidebar_label:"6065 - Commandline arguments injection"},d=void 0,m={unversionedId:"warning_codes/code-6065-public",id:"warning_codes/code-6065-public",title:"6065 - Commandline arguments injection",description:"TL;DR",source:"@site/docs/warning_codes/6065.md",sourceDirName:"warning_codes",slug:"/warning_codes/code-6065-public",permalink:"/docs/warning_codes/code-6065-public",draft:!1,editUrl:"https://github.com/facebook/pyre-check/tree/main/documentation/website/docs/warning_codes/6065.md",tags:[],version:"current",frontMatter:{id:"code-6065-public",title:"6065 - Commandline arguments injection",sidebar_label:"6065 - Commandline arguments injection"},sidebar:"pysa",previous:{title:"5001 - Code Injection",permalink:"/docs/warning_codes/code-5001-public"},next:{title:"Additional Resources",permalink:"/docs/pysa-additional-resources"}},u={},p=[{value:"TL;DR",id:"tldr",level:2},{value:"ISSUE",id:"issue",level:3},{value:"EXAMPLE",id:"example",level:3},{value:"RECOMMENDED SOLUTION",id:"recommended-solution",level:3},{value:"SEVERITY SCORING",id:"severity-scoring",level:2},{value:"CRITICAL",id:"critical",level:3},{value:"Examples:",id:"examples",level:4},{value:"SIGNIFICANT",id:"significant",level:3},{value:"Examples:",id:"examples-1",level:4},{value:"LIMITED/BAD PRACTICE",id:"limitedbad-practice",level:3},{value:"Examples:",id:"examples-2",level:4},{value:"FALSE POSITIVE",id:"false-positive",level:3},{value:"DO NOT CARE",id:"do-not-care",level:3}],h=(r="SubprocessFbSolution",function(e){return console.warn("Component "+r+" was not imported, exported, or provided by MDXProvider as global scope"),(0,o.mdx)("div",e)}),x={toc:p};function b(e){var n=e.components,t=(0,i.A)(e,s);return(0,o.mdx)("wrapper",(0,a.A)({},x,t,{components:n,mdxType:"MDXLayout"}),(0,o.mdx)("h2",{id:"tldr"},"TL;DR"),(0,o.mdx)("p",null,"This category indicates that user-controlled input flows into a command-line argument used to execute an external process. Unlike category 5001, this leads to a Remote Code Execution issue only in specific cases (e.g., ",(0,o.mdx)("inlineCode",{parentName:"p"},"shell=True")," parameter or when executing particular binaries)."),(0,o.mdx)("h3",{id:"issue"},"ISSUE"),(0,o.mdx)("p",null,(0,o.mdx)("inlineCode",{parentName:"p"},"subprocess.Popen"),", ",(0,o.mdx)("inlineCode",{parentName:"p"},"subprocess.run"),", ",(0,o.mdx)("inlineCode",{parentName:"p"},"subprocess.call"),", and other functions do a good job in preventing by default the command injection issues we described in category ",(0,o.mdx)("a",{parentName:"p",href:"/docs/warning_codes/code-5001-public"},"5001"),". The values supplied in the ",(0,o.mdx)("inlineCode",{parentName:"p"},"args")," parameter (excluding the first which represents the executable) are considered only as arguments and not as commands to be interpreted in a system shell (more details in the python ",(0,o.mdx)("a",{parentName:"p",href:"https://docs.python.org/3/library/subprocess.html#subprocess.Popen"},"documentation"),"). However, this safe behaviour can be manually bypassed by specifying the ",(0,o.mdx)("inlineCode",{parentName:"p"},"shell=True")," parameter, which reintroduces the command injection issue."),(0,o.mdx)("h3",{id:"example"},"EXAMPLE"),(0,o.mdx)("p",null,"The following code is intended to run the spellcheck binary on a user provided text:"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-python"},"def spellcheck(request: HttpRequest):\n    command = \"/usr/bin/spellcheck -l {}\".format(request.GET['text'])\n    return subprocess.run(command, shell=True)\n")),(0,o.mdx)("p",null,"An attacker, however, can supply a path such as ",(0,o.mdx)("inlineCode",{parentName:"p"},"'test' && rm -rf /"),", which would result in the following command being executed: ",(0,o.mdx)("inlineCode",{parentName:"p"},"/usr/bin/spellcheck -l 'test' && rm -rf /"),". Since this command is executed in a system shell the ",(0,o.mdx)("inlineCode",{parentName:"p"},"rm -rf /")," command will be executed after the spellcheck command."),(0,o.mdx)("h3",{id:"recommended-solution"},"RECOMMENDED SOLUTION"),(0,o.mdx)(l.OssOnly,{mdxType:"OssOnly"},(0,o.mdx)("p",null,"In general, we recommend avoiding creation of a subprocess and prefer using the API provided by the language.\nHowever, if you need to create a subprocess, we recommend using a safe API such as ",(0,o.mdx)("inlineCode",{parentName:"p"},"subprocess.run")," and avoiding use of the ",(0,o.mdx)("inlineCode",{parentName:"p"},"shell=True")," argument. If this is not possible, we recommend ensuring that the user-controlled values are shell-escaped with ",(0,o.mdx)("inlineCode",{parentName:"p"},"shlex.quote"),"."),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-python"},'def spellcheck(request: HttpRequest):\n    command = ["/usr/bin/spellcheck", "-l", request.GET[\'text\']]\n    subprocess.run(command)\n')),(0,o.mdx)("p",null,(0,o.mdx)("em",{parentName:"p"},"NOTE: be conscious of the fact that arguments to an executable can still lead to code execution (e.g., the ",(0,o.mdx)("inlineCode",{parentName:"em"},"-exec")," argument of ",(0,o.mdx)("inlineCode",{parentName:"em"},"find"),")."))),(0,o.mdx)(l.FbInternalOnly,{mdxType:"FbInternalOnly"},(0,o.mdx)(h,{mdxType:"SubprocessFbSolution"}),(0,o.mdx)("h2",{id:"severity-scoring"},"SEVERITY SCORING"),(0,o.mdx)("p",null,"A vulnerability's severity is context-dependent, but here's rough guidelines with common scenarios."),(0,o.mdx)("h3",{id:"critical"},"CRITICAL"),(0,o.mdx)("p",null,"The subprocess call uses ",(0,o.mdx)("inlineCode",{parentName:"p"},"shell=True")," AND the endpoint is externally reachable OR handles sensitive data. The attacker can inject arbitrary shell commands. Can be chained to full RCE via shell metacharacters"),(0,o.mdx)("h4",{id:"examples"},"Examples:"),(0,o.mdx)("ul",null,(0,o.mdx)("li",{parentName:"ul"},(0,o.mdx)("a",{parentName:"li",href:"https://internalfb.com/T239908731"},"T239908731"),": User-controllable shard_prefix flows directly into command construction and execution. Direct path to RCE via parameter manipulation. The vulnerability is in Akkio placement handle handlers, which manage ZippyDB database sharding infrastructure. The vulnerability is in a FBJE handler, meaning it processes jobs that could potentially have externally-controlled inputs, and executes on infrastructure managing database configurations.")),(0,o.mdx)("h3",{id:"significant"},"SIGNIFICANT"),(0,o.mdx)("p",null,"The subprocess call uses ",(0,o.mdx)("inlineCode",{parentName:"p"},"shell=True")," in internal services, OR the subprocess call doesn't use ",(0,o.mdx)("inlineCode",{parentName:"p"},"shell=True")," but the binary being executed is known to have dangerous argument handling (e.g., allows reading/writing files via arguments)."),(0,o.mdx)("h4",{id:"examples-1"},"Examples:"),(0,o.mdx)("ul",null,(0,o.mdx)("li",{parentName:"ul"},(0,o.mdx)("a",{parentName:"li",href:"https://internalfb.com/T244241355"},"T244241355"),": Thrift params flow into subprocess.run with shell=True allowing arbitrary command execution. Complete server compromise is possible with low exploitation difficulty. Internal-only service limits the attack surface to Meta employees"),(0,o.mdx)("li",{parentName:"ul"},(0,o.mdx)("a",{parentName:"li",href:"https://internalfb.com/T246423813"},"T246423813"),": User-controlled input from the patches parameter flows directly into subprocess.run() with ",(0,o.mdx)("inlineCode",{parentName:"li"},"shell=True"),", allowing arbitrary command execution. Requires internal access to the Confucius platform and attack would need to be conducted through the agent interface, which provides some indirect protection")),(0,o.mdx)("h3",{id:"limitedbad-practice"},"LIMITED/BAD PRACTICE"),(0,o.mdx)("p",null,"Argument injection without ",(0,o.mdx)("inlineCode",{parentName:"p"},"shell=True")," to a binary with no known dangerous argument patterns. Impact is limited to manipulating the specific command's behavior. Code is in experimental/internal tooling."),(0,o.mdx)("h4",{id:"examples-2"},"Examples:"),(0,o.mdx)("ul",null,(0,o.mdx)("li",{parentName:"ul"},(0,o.mdx)("a",{parentName:"li",href:"https://internalfb.com/T245745219"},"T245745219"),": Command injection in internal hackathon analect. Attack surface restricted to users with hackathon tool access.")),(0,o.mdx)("h3",{id:"false-positive"},"FALSE POSITIVE"),(0,o.mdx)("p",null,"The data flow is incorrect or the subprocess is using proper argument handling (e.g. TrustedSubprocessWithList)."),(0,o.mdx)("h3",{id:"do-not-care"},"DO NOT CARE"),(0,o.mdx)("p",null,"The flow is correct, but the command arguments are constrained to a safe set of values, OR the binary being called is safe even with arbitrary arguments.")))}b.isMDXComponent=!0}}]);