"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[134],{15680:(e,t,n)=>{n.r(t),n.d(t,{MDXContext:()=>c,MDXProvider:()=>m,mdx:()=>x,useMDXComponents:()=>u,withMDXComponents:()=>d});var a=n(96540);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(){return o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},o.apply(this,arguments)}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var c=a.createContext({}),d=function(e){return function(t){var n=u(t.components);return a.createElement(e,o({},t,{components:n}))}},u=function(e){var t=a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},m=function(e){var t=u(e.components);return a.createElement(c.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,r=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),d=u(n),m=i,h=d["".concat(r,".").concat(m)]||d[m]||p[m]||o;return n?a.createElement(h,l(l({ref:t},c),{},{components:n})):a.createElement(h,l({ref:t},c))}));function x(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,r=new Array(o);r[0]=h;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,r[1]=l;for(var c=2;c<o;c++)r[c]=n[c];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},94456:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>c,default:()=>v,frontMatter:()=>s,metadata:()=>d,toc:()=>m});var a=n(9668),i=n(21367),o=(n(96540),n(15680)),r=n(52112),l=["components"],s={id:"code-5001-public",title:"5001 - Code Injection",sidebar_label:"5001 - Code Injection"},c=void 0,d={unversionedId:"warning_codes/code-5001-public",id:"warning_codes/code-5001-public",title:"5001 - Code Injection",description:"TL;DR",source:"@site/docs/warning_codes/5001.md",sourceDirName:"warning_codes",slug:"/warning_codes/code-5001-public",permalink:"/docs/warning_codes/code-5001-public",draft:!1,editUrl:"https://github.com/facebook/pyre-check/tree/main/documentation/website/docs/warning_codes/5001.md",tags:[],version:"current",frontMatter:{id:"code-5001-public",title:"5001 - Code Injection",sidebar_label:"5001 - Code Injection"},sidebar:"pysa",previous:{title:"Overview",permalink:"/docs/warning_codes/overview-public"},next:{title:"6065 - Commandline arguments injection",permalink:"/docs/warning_codes/code-6065-public"}},u={},m=[{value:"TL;DR",id:"tldr",level:2},{value:"RCE via Code Injection (eval/exec)",id:"rce-via-code-injection-evalexec",level:2},{value:"ISSUE",id:"issue",level:3},{value:"EXAMPLE",id:"example",level:3},{value:"RECOMMENDED SOLUTION",id:"recommended-solution",level:3},{value:"RCE via Command Injection (os.system)",id:"rce-via-command-injection-ossystem",level:2},{value:"ISSUE",id:"issue-1",level:3},{value:"EXAMPLE",id:"example-1",level:3},{value:"RECOMMENDED SOLUTION",id:"recommended-solution-1",level:3},{value:"SEVERITY SCORING",id:"severity-scoring",level:2},{value:"CRITICAL",id:"critical",level:3},{value:"Examples:",id:"examples",level:4},{value:"SIGNIFICANT",id:"significant",level:3},{value:"Examples:",id:"examples-1",level:4},{value:"LIMITED/BAD PRACTICE",id:"limitedbad-practice",level:3},{value:"Examples:",id:"examples-2",level:4},{value:"FALSE POSITIVE",id:"false-positive",level:3},{value:"DO NOT CARE",id:"do-not-care",level:3}],p=function(e){return function(t){return console.warn("Component "+e+" was not imported, exported, or provided by MDXProvider as global scope"),(0,o.mdx)("div",t)}},h=p("SubprocessFbSolution"),x=p("HydraFbSolution"),f={toc:m};function v(e){var t=e.components,n=(0,i.A)(e,l);return(0,o.mdx)("wrapper",(0,a.A)({},f,n,{components:t,mdxType:"MDXLayout"}),(0,o.mdx)("h2",{id:"tldr"},"TL;DR"),(0,o.mdx)("p",null,"This category indicates that user-controlled input flows into a sink that allows code or shell command execution. This directly leads to Remote Code Execution which can be assumed to mean complete compromise of the server."),(0,o.mdx)("h2",{id:"rce-via-code-injection-evalexec"},"RCE via Code Injection (eval/exec)"),(0,o.mdx)("h3",{id:"issue"},"ISSUE"),(0,o.mdx)("p",null,"The simplest kind of RCE involves user input flowing into a function such as eval or exec which are intended to interpret or run python code."),(0,o.mdx)("h3",{id:"example"},"EXAMPLE"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-python"},'def update_search_account_filtering(request: HttpRequest) -> HttpResponse:\n    ...\n    if action in ["delete", "add", "update"]:\n        ...\n        filter_by_username = eval(request.POST.get("filter_by_username", "True"))\n')),(0,o.mdx)("h3",{id:"recommended-solution"},"RECOMMENDED SOLUTION"),(0,o.mdx)("p",null,"There are few reasons to use these functions, and even fewer reasons to allow a user to control the content of these functions. Generally, we recommend not making calls to these functions with user input. If you only need to eval python datatypes you can use ",(0,o.mdx)("inlineCode",{parentName:"p"},"ast.literal_eval"),". Using it on arbitrary user input can still lead to DOS attack but can't be exploited for code execution (",(0,o.mdx)("a",{parentName:"p",href:"https://docs.python.org/3/library/ast.html#ast.literal_eval"},"details"),")."),(0,o.mdx)("h2",{id:"rce-via-command-injection-ossystem"},"RCE via Command Injection (os.system)"),(0,o.mdx)("h3",{id:"issue-1"},"ISSUE"),(0,o.mdx)("p",null,"This kind of RCE involves user input flowing into a command executed in a system shell. If a user can control a portion of the command being executed in a shell, they can potentially add additional arbitrary commands to be executed."),(0,o.mdx)("h3",{id:"example-1"},"EXAMPLE"),(0,o.mdx)("p",null,"The following code is intended to run the spellcheck binary on a user provided text:"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-python"},"def spellcheck(request: HttpRequest):\n    command = f\"/usr/bin/spellcheck -l {request.GET['text']}\"\n    return subprocess.getoutput(command)\n")),(0,o.mdx)("p",null,"An attacker, however, can supply a path such as ",(0,o.mdx)("inlineCode",{parentName:"p"},"'test' && rm -rf /"),", which would result in the following command being executed: ",(0,o.mdx)("inlineCode",{parentName:"p"},"/usr/bin/spellcheck -l 'test' && rm -rf /"),". Since this command is executed in a system shell the ",(0,o.mdx)("inlineCode",{parentName:"p"},"rm -rf /")," command will be executed after the spellcheck command."),(0,o.mdx)("h3",{id:"recommended-solution-1"},"RECOMMENDED SOLUTION"),(0,o.mdx)(r.OssOnly,{mdxType:"OssOnly"},(0,o.mdx)("p",null,"In general, we recommend avoiding creation of a subprocess and prefer using the API provided by the language.\nHowever, if you need to create a subprocess, we recommend using an API such as ",(0,o.mdx)("inlineCode",{parentName:"p"},"subprocess.run"),", which allows you to separate arguments from the executable being invoked. ",(0,o.mdx)("strong",{parentName:"p"},"DO NOT add the ",(0,o.mdx)("inlineCode",{parentName:"strong"},"shell=True")," argument otherwise the code would still be vulnerable like the previous example")),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre",className:"language-python"},'def spellcheck(request: HttpRequest):\n    command = ["/usr/bin/spellcheck", "-l", request.GET[\'text\']]\n    subprocess.run(command)\n')),(0,o.mdx)("p",null,(0,o.mdx)("em",{parentName:"p"},"NOTE: be conscious of the fact that arguments to an executable can still lead to code execution (e.g., the ",(0,o.mdx)("inlineCode",{parentName:"em"},"-exec")," argument of ",(0,o.mdx)("inlineCode",{parentName:"em"},"find"),")."))),(0,o.mdx)(r.FbInternalOnly,{mdxType:"FbInternalOnly"},(0,o.mdx)(h,{mdxType:"SubprocessFbSolution"}),(0,o.mdx)(x,{mdxType:"HydraFbSolution"}),(0,o.mdx)("h2",{id:"severity-scoring"},"SEVERITY SCORING"),(0,o.mdx)("p",null,"A vulnerability's severity is context-dependent, but here's rough guidelines with common scenarios."),(0,o.mdx)("h3",{id:"critical"},"CRITICAL"),(0,o.mdx)("p",null,"Vulnerability affects an externally exposed endpoint (identified by SAPP feature via:reachable_from_prod or always-via:exposed_externally) OR the service handles sensitive business-critical data/user data. Direct RCE via eval(), os.system(), or subprocess.getoutput() with external user-controlled input. Service has access to sensitive credentials (hipster groups, secrets)"),(0,o.mdx)("h4",{id:"examples"},"Examples:"),(0,o.mdx)("ul",null,(0,o.mdx)("li",{parentName:"ul"},(0,o.mdx)("a",{parentName:"li",href:"https://internalfb.com/T188945618"},"T188945618"),": User input flows into DataFrame.query() which internally calls DataFrame.eval(), allowing code execution by closing quotes and invoking os.system. The vulnerability is exploitable from GraphQL with a logged-out VC, and affects a payments service handling sensitive financial data. Exploitation was confirmed via both Thrift fiddle and GraphQL endpoints.")),(0,o.mdx)("h3",{id:"significant"},"SIGNIFICANT"),(0,o.mdx)("p",null,"Vulnerability is in internal-only services, but still allows code execution with user-controlled input. The service has access to internal systems/data but not highly sensitive production data. May require internal employee access to exploit. LLM output flowing to eval/exec without isolation/sandboxing."),(0,o.mdx)("h4",{id:"examples-1"},"Examples:"),(0,o.mdx)("ul",null,(0,o.mdx)("li",{parentName:"ul"},(0,o.mdx)("a",{parentName:"li",href:"https://internalfb.com/T245530940"},"T245530940"),": User-controlled FBlearner Flow parameters flow into command execution functions. While this leads to RCE, FBlearner workflows have ACLs by default and are internal-only, reducing the exposure and exploitation difficulty for external attackers."),(0,o.mdx)("li",{parentName:"ul"},(0,o.mdx)("a",{parentName:"li",href:"https://internalfb.com/T71305397"},"T71305397"),": The augmented msgpack deserializer dynamically loads modules and calls arbitrary functions based on user-provided data, allowing code execution via specially crafted ExtType data. While technically RCE is possible via Async job scheduling, the affected component is internal and exploitation requires knowledge of the specific msgpack format and internal service architecture.")),(0,o.mdx)("h3",{id:"limitedbad-practice"},"LIMITED/BAD PRACTICE"),(0,o.mdx)("p",null,"Vulnerability is in experimental/test code, development tools, or code paths with limited reachability. The input is partially constrained that Pysa cannot detect (e.g. regex) or requires specific conditions to exploit."),(0,o.mdx)("h4",{id:"examples-2"},"Examples:"),(0,o.mdx)("ul",null,(0,o.mdx)("li",{parentName:"ul"},(0,o.mdx)("a",{parentName:"li",href:"https://internalfb.com/T226400980"},"T226400980"),": Import injection in Cardinal API. Requires malicious .json on filesystem AND classes that perform code execution, so complex attack chain reduces practical exploitability.")),(0,o.mdx)("h3",{id:"false-positive"},"FALSE POSITIVE"),(0,o.mdx)("p",null,"The data flow tracked by Pysa is incorrect (e.g., tainting the wrong fields in an object). The code uses safe deserialization."),(0,o.mdx)("h3",{id:"do-not-care"},"DO NOT CARE"),(0,o.mdx)("p",null,"The flow tracked by Pysa is correct, but exploitation is impossible (e.g. input validation that Pysa cannot detect) OR the code path is unreachable.")))}v.isMDXComponent=!0}}]);